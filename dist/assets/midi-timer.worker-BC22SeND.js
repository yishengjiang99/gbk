(function(){"use strict";function A(e,t){let n=0;for(let c=0;c<4;c+=1){const s=e[t.pos++];if(n=n<<7|s&127,!(s&128))break}return n>>>0}function D(e,t){return e[t]<<8|e[t+1]}function j(e,t){return(e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3])>>>0}function $(e,t,n){return new TextDecoder("ascii").decode(e.subarray(t,t+n))}function K(e){const t=[];let n="",c="";const s={pos:0};let r=0,i=0,a=0;for(;s.pos<e.length;){const v=A(e,s);if(r+=v,s.pos>=e.length)break;let p=e[s.pos++];if(p<128?(s.pos-=1,p=i):i=p,p===255){const d=e[s.pos++]??0,y=A(e,s),x=s.pos;if(s.pos+=y,d===47)break;if(d===3&&y>0&&(n=$(e,x,y).replace(/\0/g,"")),d===4&&y>0&&(c=$(e,x,y).replace(/\0/g,"")),d===81&&y===3){const T=e[x]<<16|e[x+1]<<8|e[x+2];t.push({seq:a++,tick:r,type:"tempo",microPerQuarter:T})}if(d===88&&y>=2){const T=e[x]||4,B=2**(e[x+1]||2);t.push({seq:a++,tick:r,type:"timeSig",numerator:T,denominator:B})}continue}if(p===240||p===247){const d=A(e,s);s.pos+=d;continue}const m=p&240,S=p&15,I=e[s.pos++]??0;let h=0;m!==192&&m!==208&&(h=e[s.pos++]??0),m===144&&h>0?t.push({seq:a++,tick:r,type:"noteOn",note:I&127,velocity:h&127,channel:S}):m===128||m===144&&h===0?t.push({seq:a++,tick:r,type:"noteOff",note:I&127,channel:S}):m===176?t.push({seq:a++,tick:r,type:"cc",cc:I&127,value:h&127,channel:S}):m===192&&t.push({seq:a++,tick:r,type:"program",program:I&127,channel:S})}return{trackName:n,instrumentName:c,events:t}}function W(e,t){const n=e.filter(i=>i.type==="tempo").map(i=>({tick:i.tick,microPerQuarter:i.microPerQuarter})).sort((i,a)=>i.tick-a.tick);(!n.length||n[0].tick!==0)&&n.unshift({tick:0,microPerQuarter:5e5});const c=[];for(const i of n)c.length&&c[c.length-1].tick===i.tick?c[c.length-1]=i:c.push(i);const s=[];let r=0;for(let i=0;i<c.length;i+=1){const a=c[i],v=c[i+1];if(s.push({tick:a.tick,startSec:r,microPerQuarter:a.microPerQuarter}),v){const p=v.tick-a.tick;r+=p*a.microPerQuarter/1e6/t}}return s}function z(e,t,n){let c=e[0];for(let s=1;s<e.length&&!(e[s].tick>n);s+=1)c=e[s];return c.startSec+(n-c.tick)*c.microPerQuarter/1e6/t}function X(e){var B;const t=new Uint8Array(e);if($(t,0,4)!=="MThd")throw new Error("Invalid MIDI header");const n=j(t,4),c=D(t,8),s=D(t,10),r=D(t,12);if(r&32768)throw new Error("SMPTE time division is not supported");let i=8+n;const a=[];for(let l=0;l<s;l+=1){if($(t,i,4)!=="MTrk")throw new Error(`Missing MTrk at track ${l}`);const b=j(t,i+4),M=i+8,P=t.subarray(M,M+b);a.push(K(P)),i=M+b}const v=a.flatMap(l=>l.events),p=W(v,r);let m=0;const S=a.map((l,g)=>{const b=[],M=[],P=new Map,H=new Uint8Array(16),J=new Uint8Array(16),_=[...l.events].sort((o,u)=>o.tick-u.tick||o.seq-u.seq);for(const o of _){const u=z(p,r,o.tick);if(m=Math.max(m,o.tick),o.type==="cc"){o.cc===0&&(H[o.channel]=o.value),o.cc===32&&(J[o.channel]=o.value);continue}if(o.type==="program"){const E=(H[o.channel]&127)<<7|J[o.channel]&127;M.push({sec:u,type:"program",channel:o.channel,program:o.program,bank:E,seq:o.seq});continue}if(o.type==="noteOn"){const E=`${o.channel}:${o.note}`,q=P.get(E)??[];q.push({startSec:u,velocity:o.velocity,note:o.note,channel:o.channel}),P.set(E,q),M.push({sec:u,type:"noteOn",channel:o.channel,note:o.note,velocity:o.velocity,seq:o.seq});continue}if(o.type==="noteOff"){const E=`${o.channel}:${o.note}`,q=P.get(E),L=q==null?void 0:q.pop();L&&b.push({note:o.note,velocity:L.velocity,channel:o.channel,startSec:L.startSec,durationSec:Math.max(.01,u-L.startSec)}),M.push({sec:u,type:"noteOff",channel:o.channel,note:o.note,seq:o.seq})}}return{index:g,name:l.trackName||`Track ${g+1}`,instrumentName:l.instrumentName||"Unknown",notes:b.sort((o,u)=>o.startSec-u.startSec),playEvents:M.sort((o,u)=>o.sec-u.sec||o.seq-u.seq)}}),h=v.filter(l=>l.type==="timeSig").sort((l,g)=>l.tick-g.tick||l.seq-g.seq)[0]??{numerator:4,denominator:4},d=((B=v.filter(l=>l.type==="tempo").sort((l,g)=>l.tick-g.tick||l.seq-g.seq)[0])==null?void 0:B.microPerQuarter)??5e5,y=Math.max(1,h.numerator*r*(4/h.denominator)),x=Math.max(1,m/y),T=z(p,r,m);return{format:c,division:r,durationSec:T,tracks:S,totalBars:x,bpm:Math.round(6e7/d),timeSig:`${h.numerator}/${h.denominator}`}}let f=null,R=new Map,k=[],O=null,w=!1,Q=0,N=0,C=0;function V(){O!=null&&clearInterval(O),O=null}function F(){for(const e of k)if(e!=null&&e.port){for(const t of e.active){const n=Number(t.split(":")[1]);e.port.postMessage({type:"noteOff",note:n})}e.active.clear()}}function G(){if(!w)return;const e=N+(performance.now()-Q)/1e3;V(),F(),w=!1,self.postMessage({type:"paused",sec:e})}function Y(e){const t=k[e.trackIndex];t!=null&&t.port&&(t.port.postMessage({type:"setPreset",regions:e.regions??[]}),t.override=!!e.override,t.presetIndex=e.presetIndex??null)}function Z(){if(!w||!f)return;const e=N+(performance.now()-Q)/1e3,t=e+.03;for(let n=0;n<f.tracks.length;n+=1){const c=f.tracks[n],s=k[n];if(s!=null&&s.port)for(;s.nextEventIndex<c.playEvents.length;){const r=c.playEvents[s.nextEventIndex];if(r.sec>t)break;r.type==="program"?s.override||self.postMessage({type:"programChangeRequest",trackIndex:n,program:r.program,bank:r.bank}):r.type==="noteOn"?(s.port.postMessage({type:"noteOn",note:r.note,velocity:r.velocity}),s.active.add(`${r.channel}:${r.note}`)):r.type==="noteOff"&&(s.port.postMessage({type:"noteOff",note:r.note}),s.active.delete(`${r.channel}:${r.note}`)),s.nextEventIndex+=1}}e-C>.09&&(self.postMessage({type:"tick",sec:e}),C=e),e>=f.durationSec&&(V(),F(),w=!1,self.postMessage({type:"ended",sec:f.durationSec}))}self.onmessage=e=>{const t=e.data;if(t.type==="loadMidi"){try{G(),f=X(t.midiData),k=(f.tracks??[]).map(n=>({nextEventIndex:0,active:new Set,override:!1,presetIndex:null,port:R.get(n.index)??null})),self.postMessage({type:"songLoaded",song:f})}catch(n){self.postMessage({type:"error",message:n instanceof Error?n.message:String(n)})}return}if(t.type==="attachPorts"){for(const n of t.ports??[])R.set(n.trackIndex,n.port);for(let n=0;n<k.length;n+=1)k[n].port=R.get(n)??null;return}if(t.type==="setTrackPreset"){Y(t);return}if(t.type==="play"){if(!f)return;const n=Math.max(0,Math.min(f.durationSec,t.startSec??0));N=n,Q=performance.now();for(let c=0;c<f.tracks.length;c+=1){const s=f.tracks[c],r=s.playEvents.findIndex(a=>a.sec>=n),i=k[c];i&&(i.nextEventIndex=r>=0?r:s.playEvents.length,i.active.clear())}C=n,V(),O=setInterval(Z,5),w=!0;return}if(t.type==="pause"){G();return}if(t.type==="seek"){if(!f)return;const n=Math.max(0,Math.min(f.durationSec,t.sec??0));for(let c=0;c<f.tracks.length;c+=1){const s=f.tracks[c],r=s.playEvents.findIndex(a=>a.sec>=n),i=k[c];i&&(i.nextEventIndex=r>=0?r:s.playEvents.length,i.active.clear())}N=n,Q=performance.now(),self.postMessage({type:"tick",sec:n})}}})();
